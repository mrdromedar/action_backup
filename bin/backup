#!/usr/bin/ruby

BACKUP_ROOT = File.join(File.dirname(__FILE__), "..")

require "stringio"
require File.join(BACKUP_ROOT, "config/mailer.rb")

Dir[File.join(BACKUP_ROOT, "lib", "*.rb")].each { |file| require file }

sio = StringIO.new
$stderr = sio
$stdout = sio

def exec_tasks(dir)
  Dir[File.join(BACKUP_ROOT, dir, "*.rb")].sort.each do |file|
    begin
      require file
    rescue Exception => e
      puts "Backup Task #{File.join(dir, file)} failed:"
      puts e
      puts e.backtrace
    end
  end
end

exec_tasks "backup/up"
exec_tasks "backup/run"

Mailer.deliver_report sio.string

exec_tasks "backup/down"

